<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="d-flex">
      <!-- <div class="col-4">
        <div class="mb-3 col-12 m-2 p-2">
          <div class=" bg-light bg-gradient">
            <h3>Login</h3>
            <form id="loginForm">
              <input id="loginEmail" class="form-control" placeholder="Email" />
              <input
                id="loginPassword"
                type="password"
                class="form-control"
                placeholder="Password"
              />
              <button type="button" id="login" class="btn btn-primary m-2">
                Login
              </button>
            </form>
          </div>
        </div>
        <div class="mb-3 col-12 m-2 p-2">
          <div class="bg-light bg-gradient">
            <h3>SignUp</h3>
            <form id="signupForm">
              <input id="signupEmail" class="form-control" placeholder="Email" />
              <input
                id="signupPassword"
                type="password"
                class="form-control"
                placeholder="Password"
              />
              <button type="button" id="signup" class="btn btn-primary m-2">
                Signup
              </button>
            </form>
  
          </div>
        </div>
      </div> -->
      <div class="col-12">
        <div class="container chat-container bg-light bg-gradient mt-2">
          <div class="bg-light chat-box">
            <h1 class="h5 mb-2">ChatRooms</h1>
            <div class="mb-3">
              <div id="chatroomList" class="d-flex flex-wrap"></div>
            </div>
            <div class="mb-3">
              <input id="name" class="form-control" placeholder="Your Name" />
            </div>
            <div class="row d-flex">
              <div class="mb-2 col-9">
                <textarea
                  id="message"
                  class="form-control"
                  placeholder="Type your message"
                ></textarea>
              </div>
              <div class="col-3">
                <button id="send" class="btn btn-success mt-2">Send</button>
                <button id="createRoom" class="btn btn-primary mt-2">
                  Create New Room
                </button>
              </div>
            </div>
          </div>
          <br />
          <div id="messages" class="chat-box"></div>
        </div>
      </div>
    </div>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
      integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
      integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
      crossorigin="anonymous"
    ></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      $(document).ready(function () {
        const socket = io();

        // Fetch available chatrooms when the page loads
        fetchChatrooms();

        // Handle chatroom selection
        $(document).on("click", ".chatroom-block", function () {
          // Remove the 'selected' class from all chatroom blocks
          $(".chatroom-block").removeClass("selected");

          const selectedChatroom = $(this).data("chatroom");
          if (selectedChatroom) {
            // Add the 'selected' class to the clicked chatroom block
            $(this).addClass("selected");

            // Join the selected chatroom
            socket.emit("join", selectedChatroom);

            // Fetch messages for the selected chatroom
            getMessages(selectedChatroom);
          }
        });

        // Handle creating a new chatroom
        $("#createRoom").click(function () {
          const newRoomName = prompt("Enter the name for the new room:");
          if (newRoomName) {
            createChatroom(newRoomName);
          }
        });

        $("#send").click(function () {
          sendMessage({
            name: $("#name").val(),
            message: $("#message").val(),
            chatroom: $(".chatroom-block.selected").data("chatroom"),
          });
        });

        socket.on("message", addMessage);

        // Listen for newRoom event
        socket.on("newRoom", function (newRoomName) {
          // Add the new room to the list
          addChatroom(newRoomName);
        });

        function fetchChatrooms() {
          $.get("/chatrooms", function (data) {
            data.forEach((chatroom) => {
              addChatroom(chatroom);
            });
          });
        }

        function addChatroom(chatroom) {
          $("#chatroomList").append(`
          <div class="chatroom-block" data-chatroom="${chatroom}">
            ${chatroom}
          </div>
        `);
        }

        function addMessage(message) {
          $("#messages").prepend(`
          <div class="message">
            <strong>${message.name}:</strong> ${message.message}
          </div>
        `);
        }

        function getMessages(chatroom) {
          $.get(`/messages/${chatroom}`, function (data) {
            $("#messages").empty();
            data.forEach(addMessage);
          });
        }

        function sendMessage(message) {
          $.post("/messages", message);
          $("#name").val("");
          $("#message").val("");
        }

        function createChatroom(newRoomName) {
          // Emit an event to the server to create the new chatroom
          socket.emit("createRoom", newRoomName);
        }
      });
    </script>
  </body>
</html>
